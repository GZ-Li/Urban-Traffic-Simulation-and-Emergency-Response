# 关键代码实现流程图

## 整体架构

```
配置文件 + 路网 + 路由
         ↓
   策略生成模块
    (流量统计)
         ↓
    策略JSON文件
         ↓
   仿真验证模块
    (独立评估)
         ↓
   评估结果JSON
         ↓
    策略对比模块
         ↓
   图表 + 报告
```

---

## 模块函数调用关系

```
┌─────────────────────────────────────────────────────────────┐
│ 模块1: 策略生成                                              │
├─────────────────────────────────────────────────────────────┤
│ generate_strategy.py                                        │
│   ├── load_config()                                         │
│   │     └── 读取config.json配置文件                        │
│   ├── calculate_traffic_flow()                             │
│   │     ├── 解析.rou.xml路由文件                           │
│   │     ├── 遍历所有vehicle节点                            │
│   │     └── 统计每组积水点的车流量                         │
│   ├── generate_best_strategy()    - 最优策略生成           │
│   │     ├── 调用calculate_traffic_flow()                   │
│   │     ├── 按流量降序排序                                  │
│   │     ├── 划分排水批次(每批3组)                          │
│   │     └── 保存best_strategy.json                         │
│   └── generate_worst_strategy()   - 最差策略生成           │
│         ├── 调用calculate_traffic_flow()                   │
│         ├── 按流量升序排序                                  │
│         ├── 划分排水批次(每批3组)                          │
│         └── 保存worst_strategy.json                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 模块2: 仿真评估                                              │
├─────────────────────────────────────────────────────────────┤
│ evaluate_strategy.py                                        │
│   ├── load_config()                                         │
│   │     └── 读取config.json配置文件                        │
│   ├── load_strategy()                                       │
│   │     └── 读取策略JSON文件                               │
│   ├── get_group_lanes()                                     │
│   │     ├── 解析.net.xml路网文件                           │
│   │     └── 将edge ID转换为lane ID列表                    │
│   ├── evaluate_strategy()         - 策略评估主流程         │
│   │     ├── 调用load_config()                              │
│   │     ├── 调用load_strategy()                            │
│   │     ├── 调用get_group_lanes()                          │
│   │     └── 对每个批次调用run_sumo_with_drainage_state()  │
│   └── run_sumo_with_drainage_state()  - 单批次仿真评估     │
│         ├── traci.start() - 启动仿真                       │
│         ├── 设置初始车速限制                                │
│         ├── 仿真循环(200秒)                                 │
│         │   ├── traci.simulationStep() - 推进1秒           │
│         │   └── 持续对积水区域车辆限速                     │
│         ├── 在延迟点测量性能指标                            │
│         │   ├── 累计通过量 - 统计离开积水区车辆           │
│         │   ├── 排队长度 - 积水车道平均车辆数             │
│         │   └── 平均速度 - 积水区域车辆均速               │
│         ├── traci.close() - 关闭仿真                       │
│         └── 返回性能指标JSON                                │
├─────────────────────────────────────────────────────────────┤
│ simulator_adapter.py (自定义模拟器适配器)                   │
│   ├── start_simulation() - 启动仿真                        │
│   ├── simulation_step() - 推进仿真1秒                      │
│   ├── get_lane_vehicle_ids() - 查询车道车辆               │
│   ├── set_vehicle_max_speed() - 设置车辆限速              │
│   ├── get_vehicle_speed() - 查询车辆速度                  │
│   ├── get_vehicle_position() - 查询车辆位置               │
│   ├── get_lane_vehicle_count() - 统计车道车辆数           │
│   ├── close_simulation() - 关闭仿真                       │
│   └── edge_to_lanes() - Edge转Lane映射                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 模块3: 策略对比                                              │
├─────────────────────────────────────────────────────────────┤
│ compare_strategies.py                                       │
│   ├── load_evaluation_result()                             │
│   │     └── 读取评估结果JSON文件                           │
│   ├── compare_results()            - 对比分析主流程        │
│   │     ├── 调用load_evaluation_result() 加载多个策略结果 │
│   │     ├── 提取性能指标数据                                │
│   │     ├── 生成对比图表                                    │
│   │     │   ├── 累计通过量对比曲线                         │
│   │     │   ├── 排队长度对比曲线                           │
│   │     │   ├── 平均速度对比曲线                           │
│   │     │   └── 排水进度曲线                               │
│   │     ├── 生成文本报告                                    │
│   │     │   ├── 策略描述                                    │
│   │     │   ├── 详细数据表格                               │
│   │     │   └── 改进分析(百分比)                           │
│   │     ├── 保存comparison_chart.png                       │
│   │     ├── 保存comparison_report.txt                      │
│   │     └── 保存comparison_report.json                     │
│   └── main() - 命令行入口                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 主流程                                                       │
├─────────────────────────────────────────────────────────────┤
│ main.py / run_pipeline.py                                  │
│   └── 完整流程编排                                          │
│         ├── 1. 调用generate_best_strategy()                │
│         ├── 2. 调用generate_worst_strategy()               │
│         ├── 3. 调用evaluate_strategy(best)                 │
│         ├── 4. 调用evaluate_strategy(worst)                │
│         └── 5. 调用compare_results([best, worst])          │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心算法说明

### 静态评估方法

每个排水状态运行独立仿真，避免历史影响：

```
批次0 (全积水) → 独立仿真 → 测量指标
批次1 (3组排完) → 独立仿真 → 测量指标
批次2 (6组排完) → 独立仿真 → 测量指标
批次3 (全排完) → 独立仿真 → 测量指标
```

### 持续限速机制

```python
for step in range(200):  # 每秒
    仿真推进()
    for 积水车道 in 未排水组:
        for 车辆 in 车道车辆列表:
            设置限速(车辆, 1.5m/s)  # 每步都设置
```

---

## 数据流

```
路由文件 → 流量统计 → 策略排序 → 批次划分
                                    ↓
                              策略JSON
                                    ↓
                    ┌───────────────┴───────────────┐
                    ↓                               ↓
              批次0仿真                         批次1仿真
           (全积水,指标)                    (3组排完,指标)
                    ↓                               ↓
                    └───────────────┬───────────────┘
                                    ↓
                             策略对比分析
                                    ↓
                            图表 + 报告
```

---

**完成时间**: 2026-02-03  
**更新说明**: 详细描述排涝策略生成和仿真验证两大核心模块的实现逻辑
