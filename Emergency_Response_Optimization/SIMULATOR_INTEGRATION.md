# 与交通模拟器对接流程

## 对接流程

```
┌────────────────────────────────────────────────────────────────────┐
│ 与交通模拟器对接流程                                                  │
├────────────────────────────────────────────────────────────────────┤
│ 1. 路网格式转换                                                      │
│    └─> 将模拟器路网转换为NetworkX图结构                              │
│    └─> 保持Edge ID一致性，确保与模拟器路网对应                       │
│    └─> 实现在 `src/path_planning.py` 或新建适配函数                 │
│                                                                      │
│ 2. 路径规划                                                          │
│    └─> 在NetworkX图上运行K短路算法 (Yen算法)                        │
│    └─> 基于路段length和speed计算理论时间                             │
│    └─> 构建时间矩阵: time_matrix[hospital][accident]                │
│                                                                      │
│ 3. 优化求解                                                          │
│    └─> 运行匈牙利算法+二分搜索求解最优分配                           │
│    └─> 输出: 每个事故点分配到哪个医院的映射关系                      │
│    └─> 生成optimal_paths.json和greedy_paths.json                   │
│                                                                      │
│ 4. 模拟器仿真验证 (关键对接步骤)                                      │
│    └─> 根据分配方案在模拟器中创建救护车实体                          │
│    └─> 设置起点(医院edge)、终点(事故点edge)、路由(edge序列)         │
│    └─> 实时查询车辆位置，判断是否到达，记录实际响应时间              │
│                                                                      │
│ 5. 结果对比评估                                                      │
│    └─> 对比理论时间 vs 实际仿真时间                                  │
│    └─> 统计成功到达率、最大响应时间等指标                            │
│    └─> 生成可视化图表: comparison.png, assignment_map.png          │
└────────────────────────────────────────────────────────────────────┘
```

## 需要实现的模拟器接口

```
┌─────────────────────────────────────────────────────────────┐
│ 模拟器适配接口 (simulator_adapter.py)                        │
├─────────────────────────────────────────────────────────────┤
│ 1. 路网加载                                                  │
│    └── load_network(network_file)                          │
│        返回: 包含edges和junctions信息的路网对象              │
│                                                             │
│ 2. 仿真控制                                                  │
│    ├── start_simulation(config)                            │
│    │   功能: 启动模拟器实例                                  │
│    ├── simulation_step()                                   │
│    │   功能: 推进仿真一个时间步                             │
│    └── close_simulation()                                  │
│        功能: 关闭模拟器                                      │
│                                                             │
│ 3. 车辆管理                                                  │
│    ├── add_vehicle(veh_id, route_edges, depart_time)       │
│    │   功能: 创建救护车，设置路由                            │
│    ├── get_vehicle_edge(veh_id)                            │
│    │   功能: 查询车辆当前所在edge_id                        │
│    └── is_vehicle_arrived(veh_id, target_edge)             │
│        功能: 判断车辆是否到达目标edge                        │
│                                                             │
│ 4. 数据查询                                                  │
│    ├── get_edge_info(edge_id)                              │
│    │   返回: {length, speed, from, to}                     │
│    └── get_simulation_time()                               │
│        返回: 当前仿真时间(秒)                                │
└─────────────────────────────────────────────────────────────┘
```

## 关键注意事项

1. **Edge ID一致性**: 路网转换时保持Edge ID不变，算法输出的路径edge序列必须与模拟器路网对应

2. **时间单位统一**: 算法使用秒为单位，模拟器接口也需统一为秒

3. **路径格式**: 路径以edge_id列表形式传递: `["edge1", "edge2", "edge3"]`

4. **替换traci调用**: 在`test_case.py`或`src/sumo_simulation.py`中，将所有`traci.*`调用替换为适配器接口
